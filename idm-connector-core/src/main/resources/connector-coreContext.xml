<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:aop="http://www.springframework.org/schema/aop"
    xmlns:tx="http://www.springframework.org/schema/tx"
    xmlns:jee="http://www.springframework.org/schema/jee"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
    					http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd
    					http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
    					http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.5.xsd">

	<!-- Authentication Beans -->
	<bean id="exampleConnector" class="org.openiam.spml2.spi.example.ExampleComplete">
	
	</bean>

	<bean id="oracleConnector" class="org.openiam.spml2.spi.orcl.OracleConnectorImpl">
	
	</bean>

	<bean id="defaultProvision" class="org.openiam.provision.service.DefaultProvisioningService">
			<property name="loginManager" ref="loginManager" />
			<property name="loginDao" ref="loginDAO" />
			<property name="userMgr" ref="userManager" />	
			<property name="auditDataService" ref="auditDataService" />	
			<property name="managedSysService" ref="managedSysService" />	
			<property name="roleDataService" ref="roleDataService" />
			<property name="groupManager" ref="groupManager" />
			<property name="sysConfiguration" ref="sysConfiguration" />
			<property name="connectorWsdl" value="WEB-INF/wsdl/ConnectorService.wsdl" />
			<property name="defaultProvisioningModel" value="ROLE" />
			<property name="resourceDataService" ref="resourceDataService" />
			<property name="scriptEngine" value="org.openiam.script.GroovyScriptEngineIntegration" />
			<property name="orgManager" ref="orgManager" />
			<property name="passwordDS" ref="passwordManager" />
			<property name="addUser" ref="addUser" />
			<property name="modifyUser" ref="modifyUser" />
			<property name="auditHelper" ref="auditHelper" />
			<property name="attrListBuilder" ref="attributeListBuilder" />
			<property name="connectorAdapter" ref="connectorAdapter" />
	</bean>
	
	<bean id="addUser" class="org.openiam.provision.service.AddUser" scope="prototype">
			<property name="loginManager" ref="loginManager" />
			<property name="userMgr" ref="userManager" />	
			<property name="roleDataService" ref="roleDataService" />
			<property name="groupManager" ref="groupManager" />
			<property name="sysConfiguration" ref="sysConfiguration" />
			<property name="resourceDataService" ref="resourceDataService" />
	</bean>

	<bean id="modifyUser" class="org.openiam.provision.service.ModifyUser"  scope="prototype">
			<property name="loginManager" ref="loginManager" />
			<property name="userMgr" ref="userManager" />	
			<property name="roleDataService" ref="roleDataService" />
			<property name="groupManager" ref="groupManager" />
			<property name="auditHelper" ref="auditHelper" />
	</bean>
	
	<bean id="attributeListBuilder" class="org.openiam.provision.service.AttributeListBuilder" scope="prototype"/>
	<bean id="connectorAdapter" class="org.openiam.provision.service.ConnectorAdapter">
		<property name="connectorService" ref="connectorService" />	
	</bean>
	

	
	<bean id="provision" class="org.openiam.provision.service.ProvisionServiceImpl">
			<property name="loginManager" ref="loginManager" />
			<property name="loginDao" ref="loginDAO" />
			<property name="userMgr" ref="userManager" />	
			<property name="auditDataService" ref="auditDataService" />	
			<property name="connectorService" ref="connectorService" />	
			<property name="managedSysService" ref="managedSysService" />	
			<property name="roleDataService" ref="roleDataService" />
			<property name="groupManager" ref="groupManager" />
			<property name="sysConfiguration" ref="sysConfiguration" />
			<property name="connectorWsdl" value="WEB-INF/wsdl/ConnectorService.wsdl" />
			<property name="defaultProvisioningModel" value="ROLE" />
			<property name="resourceDataService" ref="resourceDataService" />
			<property name="scriptEngine" value="org.openiam.script.GroovyScriptEngineIntegration" />
			<property name="orgManager" ref="orgManager" />
			<property name="passwordDS" ref="passwordManager" />
			<property name="auditHelper" ref="auditHelper" />
	</bean>

	<bean id="attrHelper" class="org.openiam.provision.service.UserAttributeHelper">
			<property name="loginManager" ref="loginManager" />
	</bean>
	
	<bean id="ldapConnector" class="org.openiam.spml2.spi.ldap.LdapConnectorImpl">
		<property name="managedSysService" ref="managedSysService" />	
		<property name="managedSysObjectMatchDao" ref="managedSysObjectMatchDAO" />
		<property name="resourceDataService" ref="resourceDataService" />
	</bean>

	<bean id="activeDirConnector" class="org.openiam.spml2.spi.ad.ActiveDirConnectorImpl">
		<property name="managedSysService" ref="managedSysService" />	
		<property name="managedSysObjectMatchDao" ref="managedSysObjectMatchDAO" />
	</bean>

	<bean id="scriptConnector" class="org.openiam.spml2.spi.script.ScriptConnectorImpl">
		<property name="managedSysService" ref="managedSysService" />	
		<property name="managedSysObjectMatchDao" ref="managedSysObjectMatchDAO" />
		<property name="resourceDataService" ref="resourceDataService" />
		<property name="scriptEngine" value="org.openiam.script.GroovyScriptEngineIntegration" />
	</bean>

<!-- ========================= Synchronization ========================= -->

	<bean id="synchService" class="org.openiam.idm.srvc.synch.service.IdentitySynchServiceImpl">
		<property name="synchConfigDao" ref="synchConfigDAO" />	
		<property name="synchConfigMappingDao" ref="synchConfigDataMappingDAO" />	
	</bean>
	<bean id="synchServiceWS" class="org.openiam.idm.srvc.synch.ws.IdentitySynchWebServiceImpl">
		<property name="synchService" ref="synchService" />	
	</bean>

	<bean id="synchConfigDAO" class="org.openiam.idm.srvc.synch.service.SynchConfigDAOImpl" >
		<property name="sessionFactory" ref="sesFactory" />		
	</bean>	
	<bean id="synchConfigDataMappingDAO" class="org.openiam.idm.srvc.synch.service.SynchConfigDataMappingDAOImpl" >
		<property name="sessionFactory" ref="sesFactory" />		
	</bean>	
	
<!-- ========================= Reconciliation ========================= -->

	<bean id="reconService" class="org.openiam.idm.srvc.recon.service.ReconciliationServiceImpl">
		<property name="reconSituationDao" ref="reconSituationDAO" />	
		<property name="reconConfigDao" ref="reconConfigDAO" />	
		<property name="reconResultDao" ref="reconResultDAO" />	
		<property name="reconResultDetailDao" ref="reconResultDetailDAO" />	
	</bean>
	<bean id="reconServiceWS" class="org.openiam.idm.srvc.recon.ws.ReconciliationWebServiceImpl">
	<property name="reconService" ref="reconService" />	
	</bean>
	
	<bean id="reconSituationDAO" class="org.openiam.idm.srvc.recon.service.ReconciliationSituationDAOImpl" >
		<property name="sessionFactory" ref="sesFactory"></property>		
	</bean>	
	<bean id="reconConfigDAO" class="org.openiam.idm.srvc.recon.service.ReconciliationConfigDAOImpl" >
		<property name="sessionFactory" ref="sesFactory"></property>		
	</bean>	
	<bean id="reconResultDAO" class="org.openiam.idm.srvc.recon.service.ReconciliationResultDAOImpl" >
		<property name="sessionFactory" ref="sesFactory"></property>		
	</bean>	
	<bean id="reconResultDetailDAO" class="org.openiam.idm.srvc.recon.service.ReconciliationResultDAOImpl" >
		<property name="sessionFactory" ref="sesFactory"></property>		
	</bean>	

	<!-- ========================= RESOURCE DEFINITIONS ========================= -->

	<bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
	    <property name="locations">
	    	<list>
		        <value>classpath:datasource.properties</value>
		        <value>classpath:securityconf.properties</value>
	        </list>
	    </property>
	</bean>
	
	<bean id="sesFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
		<property name="dataSource" ref="dataSrc"/>
		<property name="mappingResources">
			<list>
				<value>org/openiam/idm/srvc/recon/service/ReconciliationConfig.hbm.xml</value>
				<value>org/openiam/idm/srvc/recon/service/ReconciliationResult.hbm.xml</value>
				<value>org/openiam/idm/srvc/recon/service/ReconciliationSituation.hbm.xml</value>
				<value>org/openiam/idm/srvc/recon/service/ReconResultDetail.hbm.xml</value>
				<value>org/openiam/idm/srvc/synch/service/SynchConfig.hbm.xml</value>
				<value>org/openiam/idm/srvc/synch/service/SynchConfigDataMapping.hbm.xml</value>
			</list>
		</property>
		<property name="hibernateProperties">
			<props>
				<prop key="hibernate.dialect">${openiam.hibernate.dialect}</prop>	
				<prop key="hibernate.show_sql">false</prop>
				<prop key="hibernate.generate_statistics">true</prop>
				<prop key="hibernate.cache.provider_class">org.hibernate.cache.EhCacheProvider</prop>
				<prop key="hibernate.cache.use_query_cache">true</prop>
				<prop key="hibernate.max_fetch_depth">2</prop>
				<prop key="hibernate.jdbc.fetch_size">${fetch.size}</prop>
				<prop key="hibernate.c3p0.minPoolSize">${openiam.hibernate.minPoolSize}</prop>
   				<prop key="hibernate.c3p0.maxPoolSize">${openiam.hibernate.maxPoolSize}</prop>
   				<prop key="hibernate.c3p0.timeout">${openiam.hibernate.timeout}</prop>
   				<prop key="hibernate.c3p0.max_statement">${openiam.hibernate.max_statement}</prop>
   				<prop key="hibernate.c3p0.idle_test_period">${openiam.hibernate.idle_test_period}</prop>
				
			</props>
		</property>	
	</bean>


  
	<!-- Local DataSource that works in any environment -->
	<!-- Note that DriverManagerDataSource does not pool; it is not intended for production -->
	<!-- See JPetStore for an example of using Commons DBCP BasicDataSource as alternative -->
	<!-- See Image Database for an example of using C3P0 ComboPooledDataSource as alternative -->

     <bean id="dataSrc" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
        <property name="driverClassName" value="${openiam.driver_classname}" />
        <property name="url" value="${openiam.driver_url}" />
        <property name="username" value="${openiam.username}" />
        <property name="password" value="${openiam.password}" />
     </bean>

	<bean id="transactionManager" class="org.springframework.orm.hibernate3.HibernateTransactionManager">
    	<property name="sessionFactory" ref="sesFactory"/>
  	</bean>
  	
  	<tx:annotation-driven transaction-manager="transactionManager"/>


  <tx:advice id="txAdvice" transaction-manager="transactionManager">
    <!-- the transactional semantics... -->
    <tx:attributes>
      <!-- all methods starting with 'get' are read-only -->
      <tx:method name="get*" read-only="true" propagation="SUPPORTS" />
      <!-- other methods use the default transaction settings (see below) -->
      <tx:method name="*" propagation="REQUIRED"/>
      <tx:method name="send*" read-only="true" propagation="NOT_SUPPORTED" />
    </tx:attributes>
  </tx:advice>
  
  

  <!-- ensure that the above transactional advice runs for any execution
      of an operation defined by the FooService interface -->

  <aop:config>
    <aop:pointcut id="provisionOperation" expression="execution(* org.openiam.provision.service.ProvisionService.*(..))"/>
    <aop:advisor advice-ref="txAdvice" pointcut-ref="provisionOperation"/>
  </aop:config>
 
  <aop:config>
    <aop:pointcut id="ldapConnectorOperation" expression="execution(* org.openiam.spml2.spi.ldap.LdapConnectorImpl.*(..))"/>
    <aop:advisor advice-ref="txAdvice" pointcut-ref="ldapConnectorOperation"/>
  </aop:config>

  <aop:config>
    <aop:pointcut id="adConnectorOperation" expression="execution(* org.openiam.spml2.spi.ad.ActiveDirConnectorImpl.*(..))"/>
    <aop:advisor advice-ref="txAdvice" pointcut-ref="adConnectorOperation"/>
  </aop:config>

  <aop:config>
    <aop:pointcut id="scriptConnectorOperation" expression="execution(* org.openiam.spml2.spi.script.ScriptConnectorImpl.*(..))"/>
    <aop:advisor advice-ref="txAdvice" pointcut-ref="scriptConnectorOperation"/>
  </aop:config>

  <aop:config>
    <aop:pointcut id="synchServiceWSOperation" expression="execution(* org.openiam.idm.srvc.synch.ws.IdentitySynchWebServiceImpl.*(..))"/>
    <aop:advisor advice-ref="txAdvice" pointcut-ref="synchServiceWSOperation"/>
  </aop:config>
          
</beans>


